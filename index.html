<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fidget Toys 注意力实验 | 反应时间测量</title>
  <style>
    :root { --maxw: 900px; }
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans", "PingFang SC", "Microsoft YaHei", sans-serif; line-height: 1.5; margin: 0; background: #f7f7fb; color: #111; }
    header { background: white; border-bottom: 1px solid #eee; position: sticky; top: 0; z-index: 10; }
    header .wrap { max-width: var(--maxw); margin: 0 auto; padding: 12px 16px; display: flex; align-items: center; justify-content: space-between; }
    main { max-width: var(--maxw); margin: 24px auto; padding: 0 16px 48px; }
    .card { background: white; border: 1px solid #eee; border-radius: 14px; padding: 18px; box-shadow: 0 10px 30px rgba(0,0,0,0.04); margin: 16px 0; }
    h1 { font-size: 22px; margin: 6px 0; }
    h2 { font-size: 20px; margin-top: 0; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    label { font-weight: 600; font-size: 14px; }
    input[type="text"], input[type="number"], select { width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid #ddd; }
    button { padding: 10px 16px; border-radius: 12px; border: 1px solid #222; background: #111; color: #fff; cursor: pointer; font-weight: 700; }
    button.secondary { background: #fff; color: #111; border-color: #ddd; }
    button.action { background: #007bff; border-color: #007bff; font-size: 18px; padding: 14px 28px; }
    button:disabled { opacity: .5; cursor: not-allowed; }
    .center { text-align: center; }
    .muted { color: #666; font-size: 13px; }
    .progress { height: 8px; background: #eee; border-radius: 999px; overflow: hidden; }
    .bar { height: 100%; background: #111; width: 0%; transition: width 200ms linear; }
    .stim { font-size: 56px; font-weight: 800; margin: 28px 0 10px; text-align: center; }
    .choices { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin: 12px 0; }
    .hidden { display: none !important; }
    .letter-grid { width: 100%; display:grid; grid-template-columns: repeat(18, 1fr); gap: 4px; align-items:center; justify-items:center; overflow:hidden; }
    .letter-cell { font-weight: 800; line-height: 1; }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div><strong>Fidget Toys Attention Task</strong> <span class="muted">反应时间测量 RT</span></div>
      <div>
        <button id="btnUpload" class="secondary" disabled>Upload to Server</button>
        <button id="btnDownload" class="secondary" disabled>Download CSV</button>
      </div>
    </div>
  </header>

  <main>
    <section id="screen_welcome" class="card">
      <h1>Welcome to the Experiment</h1>
      <p>Please enter your participant ID and consent to participate.</p>
      <p class="muted">欢迎参加实验。请输入被试编号并勾选同意。</p>
      <div>
        <label>Participant ID 被试编号</label>
        <input id="pid" type="text" placeholder="e.g., S001" />
      </div>
      <p><label><input id="consent" type="checkbox" /> I consent to participate 我同意参与本研究</label></p>
      <div class="center"><button id="btnStart" disabled>Start 开始实验</button></div>
    </section>

    <section id="screen_instructions" class="card hidden">
      <h2 id="inst_title">Instructions</h2>
      <div id="inst_body"></div>
      <div class="center"><button id="btnBeginTask">Begin 开始</button></div>
    </section>

    <section id="screen_task" class="card hidden">
      <div class="progress"><div id="progbar" class="bar"></div></div>
      <div id="stimulus" class="stim"></div>
      <div id="choices" class="choices"></div>
      <div id="action_area" class="center"></div>
    </section>

    <section id="screen_done" class="card hidden">
      <h2>All Tasks Complete</h2>
      <p>Thank you for participating!</p>
      <div class="center"><button id="btnDownload2" class="secondary">Download CSV</button></div>
      <p id="upload_status" class="muted"></p>
    </section>
  </main>

  <script>
    // ===== Config & utils =====
    // You can override endpoint via ?endpoint=<url-encoded>
    const DEFAULT_ENDPOINT = 'https://script.google.com/macros/s/AKfycbx4svJLmENd-QLHAAUAgNsEUZijaKl5rYUR0cwaGnpKslQ7892fIQXhovuNVqg683I/exec';
    const params = new URLSearchParams(location.search);
    const ENDPOINT = decodeURIComponent(params.get('endpoint')||'') || DEFAULT_ENDPOINT;

    const $ = s => document.querySelector(s);
    const sleep = ms => new Promise(r => setTimeout(r, ms));
    const shuffle = arr => arr.map(v=>[Math.random(),v]).sort((a,b)=>a[0]-b[0]).map(x=>x[1]);

    // ===== Global state =====
    const STATE = { pid:'', trialIndex:0, taskIndex:0, data:[], trials:[] };

    // ===== Welcome form =====
    (function initWelcome(){
      const pidInput=$('#pid'), consent=$('#consent'), btnStart=$('#btnStart');
      function updateStart(){ btnStart.disabled = !(pidInput.value.trim() && consent.checked); }
      updateStart();
      pidInput.addEventListener('input',updateStart);
      consent.addEventListener('change',updateStart);
      btnStart.addEventListener('click',()=>{ STATE.pid=pidInput.value.trim(); toInstructions(0); });
    })();

    // ===== Trial builders =====
    const COLORS=[{name:'Red',css:'red'},{name:'Blue',css:'blue'},{name:'Green',css:'green'},{name:'Yellow',css:'gold'}];

    function makeSearchTrials(n=6){
      const trials=[]; const letters='ABCDEFGHIJKLMNOPQRSTUVWXYZ';
      for(let i=0;i<n;i++){
        const width=18, height=6;
        const target=Math.floor(Math.random()*4)+6; // 6-9 targets
        let cells=[];
        for(let k=0;k<target;k++) cells.push('F');
        while(cells.length<width*height){
          const ch=letters[Math.floor(Math.random()*letters.length)];
          cells.push(ch==='F'?'E':ch); // 不让“意外 F”混入
        }
        trials.push({task:'Search', grid:shuffle(cells).join(''), answer:String(target)});
      }
      return trials;
    }

    function makeStroopTrials(n=16){
      const words=['RED','BLUE','GREEN','YELLOW']; const trials=[];
      for(let i=0;i<n;i++){
        const word=words[Math.floor(Math.random()*words.length)];
        const color=COLORS[Math.floor(Math.random()*COLORS.length)];
        trials.push({task:'Stroop', word, color:color.css, answer:color.name});
      }
      return shuffle(trials);
    }

    function makeGNGTrials(n=24){
      const t=[];
      for(let i=0;i<n;i++){
        const d=Math.floor(Math.random()*9)+1;
        const go=d%2===1;
        t.push({task:'GoNoGo', digit:d, go, answer:go?'PRESS':'NO_PRESS'});
      }
      return shuffle(t);
    }

    // ===== Screens =====
    const screens={ welcome:$('#screen_welcome'), inst:$('#screen_instructions'), task:$('#screen_task'), done:$('#screen_done') };
    const instTitle=$('#inst_title'), instBody=$('#inst_body'), btnBeginTask=$('#btnBeginTask');
    function showOnly(el){ Object.values(screens).forEach(s=>s.classList.add('hidden')); el.classList.remove('hidden'); }

    function toInstructions(idx){
      STATE.taskIndex=idx; STATE.trialIndex=0; let html='';
      if(idx===0){
        instTitle.textContent='Task 1: Letter Search';
        html='Count how many <strong>F</strong> letters appear in the grid, type the number, and submit.<div class="muted">任务一：统计矩阵中 <strong>F</strong> 的数量并提交。</div>';
        STATE.trials=makeSearchTrials(6);
      } else if(idx===1){
        instTitle.textContent='Task 2: Stroop';
        html='A word appears in color. <strong>Click the INK COLOR</strong>, not the word meaning.<div class="muted">任务二：点击<strong>字体颜色</strong>，而不是单词含义。</div>';
        STATE.trials=makeStroopTrials(16);
      } else {
        instTitle.textContent='Task 3: Go / No-Go';
        html='Press the button for <strong>odd</strong> numbers; do <strong>not</strong> press for even numbers.<div class="muted">任务三：遇到奇数请点击按钮，遇到偶数不要点击。</div>';
        STATE.trials=makeGNGTrials(24);
      }
      instBody.innerHTML = '<div class="card">' + html + '</div>';
      showOnly(screens.inst);
    }

    btnBeginTask.addEventListener('click',()=>{ showOnly(screens.task); nextTrial(); });

    // ===== Runtime =====
    const stim=$('#stimulus'), choicesDiv=$('#choices'), progbar=$('#progbar'), actionArea=$('#action_area');
    function updateProgress(){
      const pct = STATE.trials.length? (STATE.trialIndex/STATE.trials.length)*100 : 0;
      if(progbar) progbar.style.width = pct.toFixed(1)+'%';
    }

    function safeDisableButtons(scope=document){
      scope.querySelectorAll('button').forEach(b=>{ b.disabled=true; });
    }

    async function nextTrial(){
      stim.innerHTML=''; choicesDiv.innerHTML=''; actionArea.innerHTML=''; updateProgress();

      // 任务完成则切到下一任务或结束页
      if(STATE.trialIndex>=STATE.trials.length){
        if(STATE.taskIndex<2){
          toInstructions(STATE.taskIndex+1);
        } else {
          showOnly(screens.done);
          try{ await uploadData(); }catch(e){}
          $('#btnUpload').disabled=false; $('#btnDownload').disabled=false;
          // 兜底：自动下载一份本地 CSV
          try{ downloadCSV(); }catch(_){}
        }
        return;
      }

      const t=STATE.trials[STATE.trialIndex];

      // --- Letter Search ---
      if(t.task==='Search'){
        const grid=document.createElement('div'); grid.className='letter-grid';
        for(const ch of t.grid){
          const cell=document.createElement('div');
          cell.className='letter-cell';
          cell.textContent=ch;
          grid.appendChild(cell);
        }
        stim.appendChild(grid);

        const input=document.createElement('input'); input.type='number'; input.placeholder='Enter number 输入数量'; input.min='0'; input.step='1';
        const submit=document.createElement('button'); submit.textContent='Submit 提交';
        actionArea.appendChild(input); actionArea.appendChild(submit);

        // 自适应字号，防止溢出
        function fit(){
          const cols=18, gap=4;
          const w=grid.clientWidth || stim.clientWidth || 800;
          const cellW=(w - (cols-1)*gap)/cols;
          const fs=Math.max(14, Math.floor(cellW*0.75));
          grid.querySelectorAll('.letter-cell').forEach(c=>{ c.style.fontSize=fs+'px'; });
        }
        fit();
        if(window.ResizeObserver){
          try{ new ResizeObserver(fit).observe(grid); }catch(_){ window.addEventListener('resize', fit, {passive:true}); }
        } else {
          window.addEventListener('resize', fit, {passive:true});
        }

        const start=performance.now();
        function finish(){
          const rt=Math.round(performance.now()-start);
          const resp=String((input.value||'').trim());
          const correct=resp===t.answer;
          record({task:'Search',stimulus:t.grid,answer:t.answer,response:resp,correct,rt});
          safeDisableButtons(actionArea);
          STATE.trialIndex++; updateProgress(); nextTrial();
        }
        submit.onclick=finish;
        input.addEventListener('keydown', e=>{
          if(e.key==='Enter'){ e.preventDefault(); finish(); }
        });
        input.focus();
        return;
      }

      // --- Stroop ---
      if(t.task==='Stroop'){
        stim.textContent=t.word; stim.style.color=t.color; stim.style.fontSize='64px';
        const trialStart = performance.now();
        COLORS.forEach(c=>{
          const b=document.createElement('button'); b.textContent=c.name;
          b.onclick=()=>{
            if (b.disabled) return;
            const rt=Math.round(performance.now()-trialStart);
            const resp=c.name;
            const correct=resp===t.answer;
            record({task:'Stroop',stimulus:(t.word + '|' + t.color),answer:t.answer,response:resp,correct,rt});
            safeDisableButtons(choicesDiv);
            STATE.trialIndex++; updateProgress(); nextTrial();
          };
          choicesDiv.appendChild(b);
        });
        return;
      }

      // --- Go / No-Go (button) ---
      if(t.task==='GoNoGo'){
        stim.textContent=String(t.digit); stim.style.color='#111'; stim.style.fontSize='72px';
        const btn=document.createElement('button'); btn.textContent='Press 按下'; btn.className='action'; actionArea.appendChild(btn);
        const trialStart=performance.now(); let responded=false;
        btn.onclick=()=>{
          if(responded) return;
          responded=true; btn.disabled=true;
          const rt=Math.round(performance.now()-trialStart);
          record({task:'GoNoGo',stimulus:String(t.digit),answer:t.answer,response:'PRESS',correct:(t.go===true),rt});
          STATE.trialIndex++; updateProgress(); nextTrial();
        };
        // 1500 ms 内未按即 NO_PRESS
        setTimeout(()=>{
          if(!responded){
            responded=true; btn.disabled=true;
            record({task:'GoNoGo',stimulus:String(t.digit),answer:t.answer,response:'NO_PRESS',correct:(t.go===false),rt:null});
            STATE.trialIndex++; updateProgress(); nextTrial();
          }
        },1500);
        return;
      }
    }

    function record({task,stimulus,answer,response,correct,rt}){
      STATE.data.push({
        pid:STATE.pid, task, trial:STATE.trialIndex+1, stimulus, answer, response,
        correct:correct?1:0, rt_ms:rt, ts:new Date().toISOString()
      });
    }

    // ===== Upload & download =====
    async function postJSON(url, payload, opts={}){
      const { timeoutMs=12000 } = opts;
      const ctrl = new AbortController();
      const t = setTimeout(()=>ctrl.abort('timeout'), timeoutMs);
      try{
        const resp = await fetch(url, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify(payload),
          mode:'cors',
          keepalive:true,
          referrerPolicy:'no-referrer',
          signal: ctrl.signal
        });
        clearTimeout(t);
        return resp;
      }catch(e){
        clearTimeout(t);
        throw e;
      }
    }

    async function uploadData(){
      const statusEl = $('#upload_status');
      function setStatus(msg){ if(statusEl) statusEl.textContent = msg; }
      if(!STATE.data.length){ setStatus('No data to upload'); return; }
      if(!navigator.onLine){ setStatus('Offline: will retry when online'); return; }
      if(!ENDPOINT){
        setStatus('Upload endpoint not set. 请在代码中配置你的 Apps Script URL 或用 ?endpoint= 覆盖');
        return;
      }
      const payload = {
        meta:{ pid:STATE.pid, tz:Intl.DateTimeFormat().resolvedOptions().timeZone, ua:navigator.userAgent },
        rows: STATE.data
      };
      setStatus('Uploading…');
      try{
        let resp = await postJSON(ENDPOINT, payload, {timeoutMs: 15000});
        // 有些部署（no-cors）返回 opaque；视为成功
        if(resp.type==='opaque' || resp.status===0){ setStatus('Uploaded (opaque) ✓'); return; }
        if(!resp.ok){ throw new Error('HTTP '+resp.status); }
        try{ await resp.json(); }catch(_){ /* 允许空响应体 */ }
        setStatus('Uploaded ✓');
      }catch(err){
        console.error('upload error', err);
        // 尝试 no-cors 兜底
        try{
          await fetch(ENDPOINT, {method:'POST', body:JSON.stringify(payload), headers:{'Content-Type':'application/json'}, mode:'no-cors', keepalive:true});
          setStatus('Uploaded (no-cors fallback) ✓');
        }catch(e2){
          setStatus('Upload failed: '+ (err && err.message ? err.message : 'Load failed'));
        }
      }finally{
        $('#btnUpload').disabled=false; $('#btnDownload').disabled=false;
      }
    }

    function toCSV(rows){
      if(!rows.length) return '';
      const headers=Object.keys(rows[0]);
      const esc=v=>{ const s=String(v??''); return /[",\n]/.test(s) ? ('"'+s.replace(/"/g,'""')+'"') : s; };
      const out=[headers.join(',')];
      for(const r of rows) out.push(headers.map(h=>esc(r[h])).join(','));
      return out.join('\n');
    }

    function downloadCSV(){
      const csv=toCSV(STATE.data);
      const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download='attention_experiment.csv';
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    }
    $('#btnDownload').addEventListener('click',downloadCSV);
    $('#btnDownload2').addEventListener('click',downloadCSV);
    $('#btnUpload').addEventListener('click', ()=>uploadData());

    // ===== Mini tests (run with ?runTests=1) =====
    (function(){
      const p=new URLSearchParams(location.search); if(p.get('runTests')!=='1') return;
      const rows=[{a:'x',b:'y,z'},{a:'"q"',b:'line\nbreak'}];
      const csv=toCSV(rows);
      console.assert(csv.includes('""q""'), 'CSV should escape quotes');
      console.assert(csv.split('\n').length===3, 'CSV should have 3 lines');
      const g=makeGNGTrials(10); console.assert(g.every(it=>['PRESS','NO_PRESS'].includes(it.answer)), 'GNG answer should be PRESS/NO_PRESS');
      const ep = decodeURIComponent(new URLSearchParams('endpoint=https%3A%2F%2Fexample.com').get('endpoint'));
      console.assert(ep==='https://example.com', 'endpoint query override works');
      console.log('Mini tests passed');
    })();

    // ===== Global error surface to page =====
    window.addEventListener('error', (e)=>{
      let box = document.getElementById('upload_status');
      if (!box) {
        box = document.createElement('p');
        box.id = 'upload_status'; box.className = 'muted';
        (document.getElementById('screen_done')||document.body).appendChild(box);
      }
      box.textContent = 'Script error: ' + (e?.error?.message || e.message || 'unknown');
      $('#btnUpload').disabled=false; $('#btnDownload').disabled=false;
    });
  </script>
</body>
</html>
